
<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd"> 
<html>
 <head>
   <link type="text/css" href="http://www.flossmanuals.net/_templates/prettify/src/prettify.css" rel="Stylesheet" />
   <script type="text/javascript" src="http://www.flossmanuals.net/_templates/prettify/src/prettify.js"></script>

   <link type="text/css" href="/site_static/js/jquery/themes/base/jquery.ui.all.css" rel="Stylesheet" >
   <link type="text/css" href="/site_static/js/jquery/themes/smoothness/jquery.ui.all.css" rel="Stylesheet" >
   <script type="text/javascript" src="/static/js/jquery-1.7.js"></script>
<!--
   <script type="text/javascript" src="/site_static/js/jquery/jquery-1.4.4.js"></script>
-->   
<script type="text/javascript" src="/site_static/js/jquery/ui/jquery-ui-1.8.10.custom.js"></script>
   <script type="text/javascript" src="/site_static/js/jquery.json-1.3.js"></script>
   <script type="text/javascript" src="/site_static/js/booki.js"></script>

   <link href="/site_static/css/jquery.bubblepopup.v2.3.1.css" rel="stylesheet" type="text/css" />
   <script src="/site_static/js/jquery.bubblepopup.v2.3.1.min.js" type="text/javascript"></script>

   <link type="text/css" href="/static/css/booki_fm.css" rel="Stylesheet"/ >
<style>
.template {
	display: none !important;
}


#header {
    background-color: transparent !important;
}
.paginator { padding:.5em .75em; float:left; font:normal .8em arial; }
 
.paginator .prev-na,
.paginator .next-na {
	padding:.3em;
	font-weight: bold;
/*	font:bold .875em arial; */
}
 
.paginator .prev-na,
.paginator .next-na {
/*	border:1px solid #ccc; 
	background-color:#f9f9f9; */
	color:#aaa;
	font-weight:normal;
}
 
.paginator .prev a, .paginator .prev a:visited,
.paginator .next a, .paginator .next a:visited {
/*	border:1px solid #c2ee62; 
	background-color:#edfdd0; */
	color:#234f32;
	padding:.3em;
/*	font:bold .875em arial; */
        font-weight: bold;
}
 
.paginator .prev, .paginator .prev-na { margin-right:.5em; }
.paginator .next, .paginator .next-na { margin-left:.5em; }
 
.paginator .page a, .paginator .page a:visited, .paginator .curr {
	padding:.25em;
	font-weight: normal;
/*	font:normal .875em verdana; */
/*	border:1px solid #C2EE62; 
	background-color:#EDFDD0; */
	margin:0em .25em;	
	color:#006000;
}
 
.paginator .curr { 
/*	background-color:#234f32; 
	color:#fff; */
	border:1px solid #234f32; 
	font-weight:bold;
	font-size:1em;
}
 
.paginator .page a:hover,
.paginator .curr a:hover,
.paginator .prev a:hover,
.paginator .next a:hover {
/*	color:#fff;
	background-color:#234f32;
	border:1px solid #234f32; */
}
</style>
 <script type="text/javascript">
      $(function() {
   $.booki.sputnikDispatcherURL = "/_sputnik/";
    });
   </script>

   <script type="text/javascript">
     $(function() {
	 // open debug window
	 $.booki.debug.init();
	 
	 
	 $("A.debug").click(function() {
	     $("#bookidebug").dialog("open");
	     return false;
	 });
     });
   </script>

   
<title>/chapter: Extending-Csound / CSound</title>
<link type="text/css" href="/site_static/css/editor.css" rel="Stylesheet" />

<script src="http://assets.annotateit.org/annotator/v1.2.5/annotator-full.min.js"></script>
<link rel="stylesheet" href="http://assets.annotateit.org/annotator/v1.2.5/annotator.min.css">



<link rel="alternate" type="application/rss+xml" title="RSS feed for CSound" href="/feeds/rss/book/csound/" /> 
<link rel="alternate" type="application/atom+xml" title="Atom feed for CSound" href="/feeds/atom/book/csound/" /> 

<link rel="alternate" type="application/rss+xml" title="RSS feed for chapter Extending-Csound" href="/feeds/rss/chapter/csound/csound/" /> 
<link rel="alternate" type="application/atom+xml" title="Atom feed for chapter Extending-Csound" href="/feeds/atom/chapter/csound/csound/" /> 


 </head>
<body onload="prettyPrint()" >
<!-- testis -->

<script type="text/javascript">
$(function() {
    $("#snippetdialog").dialog({autoOpen: false});
});
</script>


<div id="snippetdialog" title="Basic dialog">
        <p></p>
</div>



<div id="page-container"> 
<style>
body
{
margin:0;
padding:0
}
#header
{
position:absolute;
top:23px;
width:100%;
background-image: url('http://www.flossmanuals.net/_templates/fm_resources/header_bg.gif');
background-position: 700px 0px; /* this places the orange background at
an offset, making sure it doesn't underlap the left side of the gif */
background-repeat: no-repeat;
}

#fmheader {
    background-image: url("http://en.flossmanuals.net/_templates/fm_resources/header_bg.gif");
    background-position: 600px 0;
    background-repeat: no-repeat;
    position: absolute;
    top: 23px;
    width: 100%;
}
#header_image
{
margin-left: 270px;
border: 0px
}

#navigation
{
position:absolute;
top: 80px;
left: 357px;
width:50%;
}


#languages
{
position:absolute;
top: 40px;
left: 740px;
width:50%;
}
</style>



<!-- Header graphic is common to all pages  -->
<div id="header"><img id="header_image" alt="FlossManuals menu" src="http://www.flossmanuals.net/_templates/fm_resources/header_menu.gif" height="95" width="465" border="0"></div>


<!-- Navigation buttons are language and context specific  -->
<div id="navigation">
<a title="Read" href="http://en.flossmanuals.net/index.php"><img src="http://www.flossmanuals.net/_templates/fm_resources/read_en.png" width="65" height="30" border="0" alt="Read"></a>
<a title="Write" href="http://booki.flossmanuals.net/"><img src="http://www.flossmanuals.net/_templates/fm_resources/write_active_en.png" width="65" height="30" border="0" alt="Write"></a>
<a title="Remix" href="http://en.flossmanuals.net/index.php?plugin=remix"><img src="http://www.flossmanuals.net/_templates/fm_resources/remix_en.png" width="65" height="30" border="0" alt="Remix"></a>
<a title="About" href="http://www.flossmanuals.org"><img src="http://www.flossmanuals.net/_templates/fm_resources/about_en.png" width="65" height="30" border="0" alt="About"></a>
</div>

<!-- Language buttons are common to all pages  -->
<div id="languages">
<a title="English" href="http://en.flossmanuals.net/"><img src="http://www.flossmanuals.net/_templates/fm_resources/english_button.png" width="65" height="30" border="0" alt="English"></a>

<!-- <a title="Español" href="http://es.flossmanuals.net/"><img src="http://www.flossmanuals.net/_templates/fm_resources/spanish_button.png" width="65" height="30" border="0" alt="Español"></a> -->
<a title="فارسی" href="http://fa.flossmanuals.net/"><img src="http://www.flossmanuals.net/_templates/fm_resources/farsi_button.png" width="65" height="30" border="0" alt="فارسی"></a>
<a title="Suomi" href="http://fi.flossmanuals.net/"><img src="http://www.flossmanuals.net/_templates/fm_resources/finnish_button.png" width="65" height="30" border="0" alt="Suomi"></a>
<br>
<a title="Français" href="http://fr.flossmanuals.net/"><img src="http://www.flossmanuals.net/_templates/fm_resources/french_button.png" width="65" height="30" border="0" alt="Français"></a>
<a title="Nederlands" href="http://nl.flossmanuals.net/"><img src="http://www.flossmanuals.net/_templates/fm_resources/dutch_button.png" width="65" height="30" border="0" alt="Nederlands"></a>
<!-- <a title="Pусский" href="http://ru.flossmanuals.net/"><img src="http://www.flossmanuals.net/_templates/fm_resources/russian_button.png" width="65" height="30" border="0" alt="Pусский"></a> -->
<a title="Translate" href="http://translate.flossmanuals.net/"><img src="http://www.flossmanuals.net/_templates/fm_resources/translate_button.png" width="65" height="30" border="0" alt="Translate"></a>
</div>

<!-- End top bar -->

<!-- nav box + drop shadow -->
<div class="navbox shadow" style="top:160px;">
    		<ul>

 		<li><a href="/accounts/signin/?redirect=/csound/_draft/_v/1.0/extending-csound/">Sign In</li><li>Register</a></li>

                <li><a href="/list-books">All Manuals</a></li>
                <li><a href="/list-groups">All Groups</a></li>
                <li><a href="/list-people/">All People</a></li>
           	</ul>
</div>
<!-- End of nav box -->



<div class="content-container shadow">
<!-- Content box and the drop shadow-->




<br clear="all"/>
   <h1>CSound</h1>


<div id="bookmenu"   style="background: url(/site_static/images/draft_bg.png) repeat !important;">
<ul>

 
   <li><b>INTRODUCTION</b></li>
 

 
   <li><a href="/csound/_draft/_v/1.0/introduction/">PREFACE</a></li>
 

 
   <li><a href="/csound/_draft/_v/1.0/how-to-use-this-manual/">HOW TO USE THIS MANUAL</a></li>
 

 
   <li><a href="/csound/_draft/_v/1.0/on-this-release/">ON THIS RELEASE</a></li>
 

 
   <li><a href="/csound/_draft/_v/1.0/credits/">CREDITS</a></li>
 

 
   <li><b>01 BASICS</b></li>
 

 
   <li><a href="/csound/_draft/_v/1.0/a-digital-audio/">A. DIGITAL AUDIO</a></li>
 

 
   <li><a href="/csound/_draft/_v/1.0/b-pitch-and-frequency/">B. PITCH AND FREQUENCY</a></li>
 

 
   <li><a href="/csound/_draft/_v/1.0/c-intensities/">C. INTENSITIES</a></li>
 

 
   <li><a href="/csound/_draft/_v/1.0/random/">D. RANDOM</a></li>
 

 
   <li><b>02 QUICK START</b></li>
 

 
   <li><a href="/csound/_draft/_v/1.0/a-make-csound-run/">A. MAKE CSOUND RUN</a></li>
 

 
   <li><a href="/csound/_draft/_v/1.0/b-csound-syntax/">B. CSOUND SYNTAX</a></li>
 

 
   <li><a href="/csound/_draft/_v/1.0/c-configuring-midi/">C. CONFIGURING MIDI</a></li>
 

 
   <li><a href="/csound/_draft/_v/1.0/d-live-audio/">D. LIVE AUDIO</a></li>
 

 
   <li><a href="/csound/_draft/_v/1.0/e-rendering-to-file/">E. RENDERING TO FILE</a></li>
 

 
   <li><b>03 CSOUND LANGUAGE</b></li>
 

 
   <li><a href="/csound/_draft/_v/1.0/a-initialization-and-performance-pass/">A. INITIALIZATION AND PERFORMANCE PASS</a></li>
 

 
   <li><a href="/csound/_draft/_v/1.0/b-local-and-global-variables/">B. LOCAL AND GLOBAL VARIABLES</a></li>
 

 
   <li><a href="/csound/_draft/_v/1.0/c-control-structures/">C. CONTROL STRUCTURES</a></li>
 

 
   <li><a href="/csound/_draft/_v/1.0/d-function-tables/">D. FUNCTION TABLES</a></li>
 

 
   <li><a href="/csound/_draft/_v/1.0/arrays/">E. ARRAYS</a></li>
 

 
   <li><a href="/csound/_draft/_v/1.0/e-triggering-instrument-events/">F. LIVE EVENTS</a></li>
 

 
   <li><a href="/csound/_draft/_v/1.0/f-user-defined-opcodes/">G. USER DEFINED OPCODES</a></li>
 

 
   <li><a href="/csound/_draft/_v/1.0/macros/">H. MACROS</a></li>
 

 
   <li><a href="/csound/_draft/_v/1.0/functional-syntax/">I. FUNCTIONAL SYNTAX</a></li>
 

 
   <li><b>04 SOUND SYNTHESIS</b></li>
 

 
   <li><a href="/csound/_draft/_v/1.0/a-additive-synthesis/">A. ADDITIVE SYNTHESIS</a></li>
 

 
   <li><a href="/csound/_draft/_v/1.0/b-subtractive-synthesis/">B. SUBTRACTIVE SYNTHESIS</a></li>
 

 
   <li><a href="/csound/_draft/_v/1.0/c-amplitude-and-ringmodulation/">C. AMPLITUDE AND RING MODULATION</a></li>
 

 
   <li><a href="/csound/_draft/_v/1.0/d-frequency-modulation/">D. FREQUENCY MODULATION</a></li>
 

 
   <li><a href="/csound/_draft/_v/1.0/e-waveshaping/">E. WAVESHAPING</a></li>
 

 
   <li><a href="/csound/_draft/_v/1.0/f-granular-synthesis/">F. GRANULAR SYNTHESIS</a></li>
 

 
   <li><a href="/csound/_draft/_v/1.0/g-physical-modelling/">G. PHYSICAL MODELLING</a></li>
 

 
   <li><a href="/csound/_draft/_v/1.0/scanned-synthesis/">H. SCANNED SYNTHESIS</a></li>
 

 
   <li><b>05 SOUND MODIFICATION</b></li>
 

 
   <li><a href="/csound/_draft/_v/1.0/a-envelopes/">A. ENVELOPES</a></li>
 

 
   <li><a href="/csound/_draft/_v/1.0/b-panning-and-spatialization/">B. PANNING AND SPATIALIZATION</a></li>
 

 
   <li><a href="/csound/_draft/_v/1.0/c-filters/">C. FILTERS</a></li>
 

 
   <li><a href="/csound/_draft/_v/1.0/d-delay-and-feedback/">D. DELAY AND FEEDBACK</a></li>
 

 
   <li><a href="/csound/_draft/_v/1.0/e-reverberation/">E. REVERBERATION</a></li>
 

 
   <li><a href="/csound/_draft/_v/1.0/f-am-rm-waveshaping/">F. AM / RM / WAVESHAPING</a></li>
 

 
   <li><a href="/csound/_draft/_v/1.0/g-granular-synthesis/">G. GRANULAR SYNTHESIS</a></li>
 

 
   <li><a href="/csound/_draft/_v/1.0/h-convolution/">H. CONVOLUTION</a></li>
 

 
   <li><a href="/csound/_draft/_v/1.0/i-fourier-analysis-spectral-processing/">I. FOURIER ANALYSIS / SPECTRAL PROCESSING</a></li>
 

 
   <li><a href="/csound/_draft/_v/1.0/k-ats-resynthesis/">K. ATS RESYNTHESIS</a></li>
 

 
   <li><a href="/csound/_draft/_v/1.0/amplitude-and-pitch-tracking/">L. AMPLITUDE AND PITCH TRACKING</a></li>
 

 
   <li><b>06 SAMPLES</b></li>
 

 
   <li><a href="/csound/_draft/_v/1.0/a-record-and-play-soundfiles/">A. RECORD AND PLAY SOUNDFILES</a></li>
 

 
   <li><a href="/csound/_draft/_v/1.0/b-record-and-play-buffers/">B. RECORD AND PLAY BUFFERS</a></li>
 

 
   <li><b>07 MIDI</b></li>
 

 
   <li><a href="/csound/_draft/_v/1.0/a-receiving-events-by-midiin/">A. RECEIVING EVENTS BY MIDIIN</a></li>
 

 
   <li><a href="/csound/_draft/_v/1.0/b-triggering-instrument-instances/">B. TRIGGERING INSTRUMENT INSTANCES</a></li>
 

 
   <li><a href="/csound/_draft/_v/1.0/c-working-with-controllers/">C. WORKING WITH CONTROLLERS</a></li>
 

 
   <li><a href="/csound/_draft/_v/1.0/d-reading-midi-files/">D. READING MIDI FILES</a></li>
 

 
   <li><a href="/csound/_draft/_v/1.0/e-midi-output/">E. MIDI OUTPUT</a></li>
 

 
   <li><b>08 OTHER COMMUNICATION</b></li>
 

 
   <li><a href="/csound/_draft/_v/1.0/osc-and-wii/">A. OPEN SOUND CONTROL</a></li>
 

 
   <li><a href="/csound/_draft/_v/1.0/csound-in-arduino/">B. CSOUND AND ARDUINO</a></li>
 

 
   <li><b>09 CSOUND IN OTHER APPLICATIONS</b></li>
 

 
   <li><a href="/csound/_draft/_v/1.0/csound-in-pd/">A. CSOUND IN PD</a></li>
 

 
   <li><a href="/csound/_draft/_v/1.0/csound-in-maxmsp/">B. CSOUND IN MAXMSP</a></li>
 

 
   <li><a href="/csound/_draft/_v/1.0/csound-in-ableton-live/">C. CSOUND IN ABLETON LIVE</a></li>
 

 
   <li><a href="/csound/_draft/_v/1.0/d-csound-as-a-vst-plugin/">D. CSOUND AS A VST PLUGIN</a></li>
 

 
   <li><b>10 CSOUND FRONTENDS</b></li>
 

 
   <li><a href="/csound/_draft/_v/1.0/qutecsound/">CSOUNDQT</a></li>
 

 
   <li><a href="/csound/_draft/_v/1.0/cecilia/">CABBAGE</a></li>
 

 
   <li><a href="/csound/_draft/_v/1.0/blue/">BLUE</a></li>
 

 
   <li><a href="/csound/_draft/_v/1.0/winxound/">WINXOUND</a></li>
 

 
   <li><a href="/csound/_draft/_v/1.0/csound-via-terminal/">CSOUND VIA TERMINAL</a></li>
 

 
   <li><a href="/csound/_draft/_v/1.0/web-based-csound/">WEB BASED CSOUND</a></li>
 

 
   <li><b>11 CSOUND UTILITIES</b></li>
 

 
   <li><a href="/csound/_draft/_v/1.0/csound-utilities/">CSOUND UTILITIES</a></li>
 

 
   <li><b>12 CSOUND AND OTHER PROGRAMMING LANGUAGES</b></li>
 

 
   <li><a href="/csound/_draft/_v/1.0/the-csound-api/">A. THE CSOUND API</a></li>
 

 
   <li><a href="/csound/_draft/_v/1.0/using-python-inside-csound/">B. PYTHON INSIDE CSOUND</a></li>
 

 
   <li><a href="/csound/_draft/_v/1.0/c-python-in-csoundqt/">C. PYTHON IN CSOUNDQT</a></li>
 

 
   <li><a href="/csound/_draft/_v/1.0/d-lua-in-csound/">D. LUA IN CSOUND</a></li>
 

 
   <li><a href="/csound/_draft/_v/1.0/e-csound-in-ios/">E. CSOUND IN iOS</a></li>
 

 
   <li><a href="/csound/_draft/_v/1.0/f-csound-on-android/">F. CSOUND ON ANDROID</a></li>
 

 
   <li><a href="/csound/_draft/_v/1.0/csound-and-haskell/">G. CSOUND AND HASKELL</a></li>
 

 
   <li><a href="/csound/_draft/_v/1.0/h-csound-and-html/">H. CSOUND AND HTML</a></li>
 

 
   <li><b>13 EXTENDING CSOUND</b></li>
 

 
   <li><a href="/csound/_draft/_v/1.0/extending-csound/">EXTENDING CSOUND</a></li>
 

 
   <li><b>OPCODE GUIDE</b></li>
 

 
   <li><a href="/csound/_draft/_v/1.0/overview/">OVERVIEW</a></li>
 

 
   <li><a href="/csound/_draft/_v/1.0/signal-processing-i/">SIGNAL PROCESSING I</a></li>
 

 
   <li><a href="/csound/_draft/_v/1.0/signal-processing-ii/">SIGNAL PROCESSING II</a></li>
 

 
   <li><a href="/csound/_draft/_v/1.0/data/">DATA</a></li>
 

 
   <li><a href="/csound/_draft/_v/1.0/realtime-interaction/">REALTIME INTERACTION</a></li>
 

 
   <li><a href="/csound/_draft/_v/1.0/instrument-control/">INSTRUMENT CONTROL</a></li>
 

 
   <li><a href="/csound/_draft/_v/1.0/math-pythonsystem-plugins/">MATHS, PYTHON/SYSTEM, PLUGINS</a></li>
 

 
   <li><b>APPENDIX</b></li>
 

 
   <li><a href="/csound/_draft/_v/1.0/writing-csound-scores-by-hand/">METHODS OF WRITING CSOUND SCORES</a></li>
 

 
   <li><a href="/csound/_draft/_v/1.0/glossary/">GLOSSARY</a></li>
 

 
   <li><a href="/csound/_draft/_v/1.0/links/">LINKS</a></li>
 

</ul>
</div>
<div id="bookcontent"   >
<title>Csound: EXTENDINGCSOUND</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<h1>EXTENDING CSOUND
</h1>
<h2>Developing Plugin Opcodes
</h2>
<p>Csound is possibly one of the most easily extensible of all modern music programming languages. The addition of unit generators (opcodes) and function tables is generally the most common type of extension to the language. This is possible through two basic mechanisms: user-defined opcodes (UDOs), written in the Csound language itself and pre-compiled/binary opcodes, written in C or C++.&nbsp;
</p>
<p>To facilitate the latter case, Csound offers a simple opcode development API, from which dynamically-loadable, or \emph{plugin} unit generators can be built.&nbsp;
</p>
<h3>Csound data types and signals
  <br>
</h3>
<p>The Csound language provides four basic data types: i-, k-, a- and f-types&nbsp; (there is also a fifth type, w, which will not be discussed here). These are used to pass the data between opcodes, each opcode input or output parameter relating to one of these types. The Csound i-type variable is used for initialisation variables, which will assume only one value in performance. Once set, they will remain constant throughout the instrument or UDO code, unless there is a reinitialisation pass. In a plugin opcode, parameters that receive i-type variables are set inside the initialisation part of the code, because they will not change during processing.
</p>
<p>The other types are used to hold scalar (k-type) , vectorial (a-type)&nbsp; and spectral-frame (f) signal variables. These will change in performance, so parameters assigned to these variables are set and modified in the opcode processing function. Scalars will hold a single value, whereas vectors hold an array of values (a vector). These values are floating-point numbers, either 32- or 64-bit, depending on the executable version used, defined in C/C++ as a custom MYFLT type.
</p>
<p>Plugin opcodes will use pointers to input and output parameters to read and write their input/output. The Csound engine will take care of allocating the memory used for its variables, so the opcodes only need to manipulate the pointers to the addresses of these variables.
</p>
<p>A Csound instrument code can use any of these variables, but opcodes will have to accept specific types as input and will generate data in one of those types. Certain opcodes, known as polymorphic opcodes, will be able to cope with more than one type for a specific parameter (input or output). This generally implies that more than one version of the opcode will have to be implemented, which will be called depending on the parameter types used.
  <br>
</p>
<h3>Plugin opcodes
</h3>
<p>Originally, Csound opcodes could only be added to the system as statically-linked code. This required that the user recompiled the whole Csound code with the added C module. The introduction of a dynamic-loading mechanism has provided a simpler way for opcode addition, which only requires the C code to be compiled and built as a shared, dynamic library. These are known in Csound parlance as plugin opcodes and the following sections are dedicated to their development process.
</p>
<h4>Anatomy of an opcode
</h4>
<p>The C code for a Csound opcode has three main programming components: a data structure to hold the internal data, an initialising function and a processing function. From an object-oriented perspective, an opcode is a simple class, with its attributes, constructor and perform methods. The data structure will hold the attributes of the class: input/output parameters and internal variables (such as delays, coefficients, counters, indices etc.), which make up its dataspace.
</p>
<p>The constructor method is the initialising function, which sets some attributes to certain values, allocates memory (if necessary) and anything that is needed for an opcode to be ready for use. This method is called by the Csound engine when an instrument with its opcodes is allocated in memory, just before performance, or when a reinitialisation is required.
</p>
<p>Performance is implemented by the processing function, or perform method, which is called when new output is to be generated. This happens at every control period, or ksmps samples. This implies that signals are generated at two different rates: the control rate, kr, and the audio rate, sr, which is kr x ksmps samples/sec. What is actually generated by the opcode, and how its perform method is implemented, will depend on its input and output Csound language data types.
</p>
<h4>Opcoding basics
</h4>
<p>C-language opcodes normally obey a few basic rules and their development require very little in terms of knowledge of the actual processes involved in Csound. Plugin opcodes will have to provide the three main programming components outlined above: a data structure plus the initialisation and processing functions. Once these elements are supplied, all we need to do is to add a line telling Csound what type of opcode it is, whether it is an i-, k- or a-rate based unit generator and what arguments it takes.
</p>
<p>The data structure will be organised in the following fashion:
  <br>1.&nbsp;&nbsp;&nbsp; The OPDS data structure, holding the common components of all opcodes.
  <br>2.&nbsp;&nbsp;&nbsp; The output pointers (one MYFLT pointer for each output)
  <br>3.&nbsp;&nbsp;&nbsp; The input pointers (as above)
  <br>4.&nbsp;&nbsp;&nbsp; Any other internal dataspace member.
</p>
<p>The Csound opcode API is defined by csdl.h, which should be included at the top of the source file. The example below shows a simple data structure for an opcode with one output and three inputs, plus a couple of private internal variables:
</p>
<pre>#include "csdl.h"

typedef struct  _newopc {

OPDS  h;
MYFLT *out;/* output pointer  */
MYFLT *in1,*in2,*in3; /* input pointers */
MYFLT  var1;  /* internal variables */
MYFLT  var2;

} newopc;
</pre>
<h4>Initialisation
</h4>
<p>The initialisation function is only there to initialise any data, such as the internal variables, or allocate memory, if needed. The plugin opcode model in Csound 6 expects both the initialisation function and the perform function to return an int value, either OK or NOTOK. Both methods&nbsp; take two arguments:&nbsp; pointers to the CSOUND data structure and the opcode dataspace. The following example shows an example initialisation function. It initialises one of the variables to 0 and the other to the third opcode input parameter.
</p>
<pre>int newopc_init(CSOUND *csound, newopc *p){
&nbsp;p-&gt;var1 = (MYFLT) 0;
&nbsp;p-&gt;var2 = *p-&gt;in3;
return OK;
}</pre>
<h4>Control-rate performance
</h4>
<p>The processing function implementation will depend on the type of opcode that is being created. For control rate opcodes, with k- or i-type input parameters, we will be generating one output value at a time. The example below shows an example of this type of processing function. This simple example just keeps ramping up or down depending on the value of the second input. The output is offset by the first input and the ramping is reset if it reaches the value of var2 (which is set to the third input argument in the constructor above).
</p>
<pre>int newopc_process_control(CSOUND *csound, newopc *p){
&nbsp;MYFLT cnt = p-&gt;var1 + *(p-&gt;in2);
&nbsp;if(cnt &gt; p-&gt;var2) cnt = (MYFLT) 0; /* check bounds */
&nbsp;*(p-&gt;out) = *(p-&gt;in1) + cnt; /* generate output */
&nbsp; p-&gt;var1 = cnt; /* keep the value of cnt */
&nbsp; return OK;
}</pre>
<h4>Audio-rate performance
</h4>
<p>For audio rate opcodes, because it will be generating audio signal vectors, it will require an internal loop to process the vector samples. This is not necessary with k-rate opcodes, because, as we are dealing with scalar inputs and outputs,&nbsp; the function has to process only one sample at a time. If we were to make an audio version of the control opcode above (disregarding its usefulness), we would have to change the code slightly. The basic difference is that we have an audio rate output instead of control rate. In this case, our output is a whole vector (a MYFLT array) with ksmps samples, so we have to write a loop to fill it. It is important to point out that the control rate and audio rate processing functions will produce exactly the same result. The difference here is that in the audio case, we will produce ksmps samples, instead of just one&nbsp; sample. However, all the vector samples will have the same value (which actually makes the audio rate function redundant, but we will use it just to illustrate our point).
</p>
<p>Another important thing to consider is to support the --sample-accurate mode introduced in Csound 6. For this we will need to add code to start processing at an offset (when this is given), and finish early (if that is required). The opcode will then lookup these two variables (called "offset" and "early") that are passed to it from the container instrument, and act to ensure these are taken into account. Without this, the opcode would still work, but not support the sample-accurate mode.
</p>
<pre>int newopc_process_audio(CSOUND *csound, newopc *p){
&nbsp;int i, n = CS_KSMPS;
&nbsp;MYFLT *aout = p-&gt;out;&nbsp; /* output signal */
&nbsp;MYFLT cnt = p-&gt;var1 + *(p-&gt;in2);
&nbsp;uint32_t offset = p-&gt;h.insdshead-&gt;ksmps_offset;
&nbsp;uint32_t early&nbsp; = p-&gt;h.insdshead-&gt;ksmps_no_end;

&nbsp;/* sample-accurate mode mechanism */
&nbsp;if(offset) memset(aout, '\0', offset*sizeof(MYFLT));
&nbsp;if(early) {
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; n -= early;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; memset(&amp;aout[n], '\0', early*sizeof(MYFLT));
&nbsp; }&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;

&nbsp; if(cnt &gt; p-&gt;var2) cnt = (MYFLT) 0; /* check bounds */
&nbsp;&nbsp;&nbsp;
&nbsp; /* processing loop&nbsp;&nbsp;&nbsp; */
&nbsp; for(i=offset; i &lt; n; i++) aout[i] = *(p-&gt;in1) + cnt;
&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp; p-&gt;var1 = cnt; /* keep the value of cnt */
&nbsp;&nbsp; return OK;
}</pre>
<p>In order for Csound to be aware of the new opcode, we will have to register it. This is done by filling an opcode registration structure OENTRY array called localops (which is static, meaning that only one such array exists in memory at a time):
</p>
<pre>static OENTRY localops[] = {
{ "newopc", sizeof(newopc), 0, 7, "s", "kki",(SUBR) newopc_init,
(SUBR) newopc_process_control, (SUBR) newopc_process_audio }
};
<p>LINKAGE
</p></pre>
<p>The OENTRY structure defines the details of the new opcode:
</p>
<ol>
  <li>the opcode name (a string without any spaces).</li>
  <li>the size of the opcode dataspace, set using the macro S(struct_name), in most cases; otherwise this is a code indicating that the opcode will have more than one implementation, depending on the type of input arguments (a polymorphic opcode).</li>
  <li>Flags to control multicore operation (0 for most cases).</li>
  <li>An int code defining when the opcode is active: 1 is for i-time, 2 is for k-rate and 4 is for a-rate. The actual value is a combination of one or more of those. The value of 7 means active at i-time (1), k-rate (2) and a-rate (4). This means that the opcode has an init function, plus a k-rate&nbsp; and an a-rate processing functions.</li>
  <li>String definition the output type(s): a, k, s (either a or k), i, m (multiple output arguments), w or&nbsp; f&nbsp; (spectral signals).</li>
  <li>Same as above, for input types: a, k, s, i, w, f, o (optional i-rate, default to 0), p (opt, default to 1), q (opt, 10),&nbsp; v(opt, 0.5), j(opt, ?1), h(opt, 127), y (multiple inputs, a-type), z (multiple inputs, k-type), Z (multiple inputs, alternating k- and a-types), m (multiple inputs, i-type), M (multiple inputs, any type) and n (multiple inputs, odd number of inputs, i-type).</li>
  <li>I-time function (init), cast to (SUBR).</li>
  <li>K-rate function.</li>
  <li>A-rate function.</li>
</ol>
<p>Since we have defined our output as 's', the actual processing function called by csound will depend on the output type. For instance
  <br>
</p>
<pre>k1&nbsp; newopc&nbsp; kin1, kin2, i1</pre>
<p>will use <font face="courier new,courier,monospace" size="2">newopc_process_control()</font>, whereas
  <br>
  <br>
</p>
<pre>a1&nbsp; newopc&nbsp; kin1, kin2, i1</pre>
<p>
  <br>will use <font face="courier new,courier,monospace" size="2">newopc_process_audio()</font>. This type of code is found for instance in the oscillator opcodes, which can generate control or audio rate (but in that case, they actually produce a different output for each type of signal, unlike our example).
</p>
<p>Finally, it is necessary to add, at the end of the opcode C code the LINKAGE macro, which defines some functions needed for the dynamic loading of the opcode.
</p>
<h4>Building opcodes
</h4>
<p>The plugin opcode is build as a dynamic module. All we need is to build the opcode as a dynamic library, as demonstrated by the examples below.
</p>
<p>On OSX:
</p>
<pre>gcc -O2 -dynamiclib -o myopc.dylib opsrc.c -DUSE_DOUBLE
&nbsp;&nbsp;&nbsp; -I/Library/Frameworks/CsoundLib64.framework/Headers</pre>
<p>Linux:
</p>
<pre>gcc -O2 -shared -o myopc.so -fPIC opsrc.c -DUSE_DOUBLE
&nbsp;&nbsp;&nbsp; -I&lt;path to Csound headers&gt;
</pre>
<p>Windows (MinGW+MSYS):
</p>
<pre>gcc -O2 -shared -o myopc.dll opsrc.c -DUSE_DOUBLE
&nbsp;&nbsp;&nbsp; -I&lt;path to Csound headers&gt;</pre>
<h4>CSD Example
</h4>
<p>To run Csound with the new opcodes, we can use the --opcode-lib=<em>libname</em> option.
  <br>
</p>
<pre>&lt;CsoundSynthesizer&gt;
&lt;CsOptions&gt;
--opcode-lib=newopc.so&nbsp; ; OSX: newopc.dylib; Windows: newopc.dll
&lt;/CsOptions&gt;
&lt;CsInstruments&gt;

schedule 1,0,100,440

instr 1

asig&nbsp;&nbsp; newopc&nbsp; 0, 0.001, 1
ksig&nbsp;&nbsp; newopc&nbsp; 1, 0.001, 1.5
aosc&nbsp;&nbsp; oscili 1000, p4*ksig
&nbsp;&nbsp;&nbsp; outs aosc*asig

endin

&lt;/CsInstruments&gt;
&lt;/CsoundSynthesizer&gt;
;example by victor lazzarini
</pre>
<p>
  <br>
</p>
   <hr/>
    <a href="/csound/_edit/">EDIT</a>

</div>

<script type="text/javascript">
jQuery(function ($) {
    $('#bookcontent').annotator()
   		.annotator('setupPlugins', {}, {
                Tags: false,
                Filter: {
                  addAnnotationFilter: false
                },
                Permissions: false,
                AnnotateItPermissions: {}
              });
});
</script>



</div>
<!-- End of content -->

</div>  
<!-- DEV TOOLS -->
<div id="bookidebug">
</div>

<!-- sputnik error page -->
<div id="dialog-sputnik-qrac" style="display: none"></div>
</body>
</html>

